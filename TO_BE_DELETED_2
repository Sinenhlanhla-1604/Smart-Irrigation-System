async function fetchSensorData() {
  try {
    // Replace simulation with real API call
    const response = await fetch('/api/user/data');
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Update temperature displays
    document.getElementById('temperature1').textContent = `${data.temperature_1 ?? '--'} °C`;
    document.getElementById('temperature2').textContent = `${data.temperature_2 ?? '--'} °C`;
    
    // Calculate average temperature
    if (data.temperature_1 && data.temperature_2) {
      const avgTemp = ((parseFloat(data.temperature_1) + parseFloat(data.temperature_2)) / 2).toFixed(1);
      document.getElementById('avg-temp').textContent = `${avgTemp}°C`;
      
      // Update temperature indicators
      updateIndicator('temp1-indicator', parseFloat(data.temperature_1) > 30 ? 'warning' : 'active');
      updateIndicator('temp2-indicator', parseFloat(data.temperature_2) > 30 ? 'warning' : 'active');
    }
    
    // Update water detection status
    if (data.water_status && Array.isArray(data.water_status)) {
      data.water_status.forEach((status, i) => {
        const waterStatus = status === 'True' ? 'Water Detected' : 'No Water';
        document.getElementById(`water${i+1}-status`).textContent = waterStatus;
        updateIndicator(`water${i+1}-indicator`, status === 'True' ? 'warning' : 'active');
      });
    }
    
    // Update door status
    if (data.door_status && Array.isArray(data.door_status)) {
      data.door_status.forEach((status, i) => {
        const doorStatus = status === 'open' ? 'Open' : 'Closed';
        document.getElementById(`door${i+1}-status`).textContent = doorStatus;
        updateIndicator(`door${i+1}-indicator`, status === 'open' ? 'warning' : 'active');
      });
    }
    
    // Update pulse meter data
    document.getElementById('pulse-count').textContent = data.pulse_count ?? '--';
    
    // Update leak detection
    const leakDetected = data.leak_detected === 'True';
    document.getElementById('leak-status').textContent = leakDetected ? 'LEAK' : 'OK';
    document.getElementById('leak-text').textContent = leakDetected ? 'Leak Detected!' : 'No Leak Detected';
    updateIndicator('leak-indicator', leakDetected ? 'danger' : 'active');
    
    // Update system metrics
    const activeSensors = calculateActiveSensors(data);
    const alertsCount = calculateAlerts(data);
    
    document.getElementById('active-sensors').textContent = activeSensors;
    document.getElementById('alerts-count').textContent = alertsCount;
    document.getElementById('uptime').textContent = data.system_uptime ?? '99.5%';
    
    // Update last updated time
    document.getElementById('last-updated').textContent = new Date().toLocaleString();
    
  } catch (error) {
    console.error('Error fetching sensor data:', error);
    showError('Failed to fetch sensor data. Please check your connection.');
    
    // Fallback to show connection error in UI
    document.getElementById('temperature1').textContent = 'Error °C';
    document.getElementById('temperature2').textContent = 'Error °C';
    document.getElementById('avg-temp').textContent = '--°C';
  }
}

// Helper function to calculate active sensors
function calculateActiveSensors(data) {
  let count = 0;
  if (data.temperature_1) count++;
  if (data.temperature_2) count++;
  if (data.water_status) count += data.water_status.length;
  if (data.door_status) count += data.door_status.length;
  if (data.pulse_count !== null) count++;
  return count;
}

// Helper function to calculate alerts
function calculateAlerts(data) {
  let alerts = 0;
  
  // Temperature alerts
  if (parseFloat(data.temperature_1) > 30) alerts++;
  if (parseFloat(data.temperature_2) > 30) alerts++;
  
  // Water detection alerts
  if (data.water_status) {
    alerts += data.water_status.filter(status => status === 'True').length;
  }
  
  // Door open alerts
  if (data.door_status) {
    alerts += data.door_status.filter(status => status === 'open').length;
  }
  
  // Leak detection alert
  if (data.leak_detected === 'True') alerts++;
  
  return alerts;
}
